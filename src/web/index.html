<!-- SuperMaze v1.4.0 - Full rebuild with API stats and victory modal -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title id="page-title">SuperMaze</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  *{box-sizing:border-box;}
  html,body{height:100%;margin:0;font-family:'Segoe UI',sans-serif;}
  body{display:flex;justify-content:center;align-items:center;transition:background .3s ease;min-height:100vh;}
  .connect-container{display:flex;justify-content:center;align-items:center;height:100%;}
  .connect-card{width:380px;border-radius:14px;box-shadow:0 12px 36px rgba(2,6,23,.36);backdrop-filter: blur(8px); background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06);}
  .maze-container{width:100%;height:100vh;position:relative;display:flex;justify-content:center;align-items:center;background:#f5f5f5;overflow:hidden;}
  .maze-grid{display:grid;gap:2px;}
  .cell{width:25px;height:25px;border-radius:6px;background:#fff;transition: background .06s;box-sizing:border-box;}
  .cell.wall{background:#333;}
  .cell.player{background:#e74c3c;box-shadow:0 0 6px rgba(231,76,60,.7) inset;}
  .cell.end{background:#2ecc71;box-shadow:0 0 6px rgba(46,204,113,.6) inset;}
  .cell.ghost{background: rgba(0,200,255,0.6);}
  .keystrokes{position:absolute;bottom:18px;left:18px;display:flex;gap:6px;flex-direction:column;color:#fff;font-weight:700;text-shadow:0 0 5px #000;}
  .keystrokes span{width:34px;height:34px;text-align:center;line-height:34px;border-radius:6px;border:1px solid rgba(255,255,255,.9);background:rgba(0,0,0,.55);}
  .stopwatch{position:absolute;top:14px;right:14px;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,.7);color:#fff;font-size:18px;}
  .back-btn{position:absolute;top:14px;left:14px;}
  @media(max-width:480px){.connect-card{width:92%;}}
  .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .title-left{display:flex;align-items:center;gap:10px;}
  .site-title{font-size:20px;font-weight:700;margin:0;}
  .status-pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px;}
  .status-online{background: rgba(16,185,129,0.14); color:#10b981; border:1px solid rgba(16,185,129,0.22);}
  .status-offline{background: rgba(239,68,68,0.12); color:#ef4444; border:1px solid rgba(239,68,68,0.18);}
  .join-card .form-control{background: rgba(255,255,255,0.04); color:inherit; border-radius:10px; border:1px solid rgba(255,255,255,0.06);}
  .join-actions{display:flex;gap:8px;margin-top:10px;}
</style>
</head>
<body class="theme-light">

<!-- USERNAME SCREEN -->
<div id="username-screen" class="connect-container">
  <div class="card connect-card text-center p-3">
    <h4>üåÄ SuperMaze</h4>
    <small>Enter your username to start</small>
    <input id="username-input" class="form-control my-2" placeholder="Username"/>
    <button id="continue-btn" class="btn btn-primary w-100">Continue</button>
  </div>
</div>

<!-- MAIN MENU -->
<div id="connect-screen" class="connect-container d-none">
  <div class="card connect-card p-3 text-center">
    <h4>üåÄ SuperMaze</h4>
    <small id="user-stats" class="d-block mb-2">XP: 0 | Runs: 0</small>
    <button id="single-btn" class="btn btn-success w-100 my-1">Singleplayer</button>
    <button id="open-join-btn" class="btn btn-warning w-100 my-1">Multiplayer</button>

    <div id="join-card" class="d-none mt-2">
      <input id="server-ip-input" class="form-control mb-1" placeholder="Server IP"/>
      <input id="server-port-input" class="form-control mb-1" placeholder="Port (default 3000)"/>
      <div class="join-actions">
        <button id="check-server-btn" class="btn btn-ghost flex-fill">Check</button>
        <button id="connect-server-btn" class="btn btn-primary flex-fill">Connect</button>
      </div>
      <small class="text-muted">Enter server IP and port to join.</small>
    </div>

    <button id="leaderboard-btn" class="btn btn-outline-secondary w-100 my-1">Leaderboard</button>
    <button id="replay-list-btn" class="btn btn-outline-primary w-100 my-1">Saved Runs</button>
  </div>
</div>

<!-- MAZE SCREEN -->
<div id="maze-screen" class="maze-container d-none">
  <div id="maze-grid" class="maze-grid"></div>
  <div id="keystrokes" class="keystrokes"></div>
  <div id="stopwatch" class="stopwatch">00:00.000</div>
  <button id="back-btn" class="btn btn-secondary back-btn">Exit</button>
</div>

<!-- VICTORY MODAL -->
<div id="victory-modal" class="d-none position-absolute" style="inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.8);z-index:9999;">
  <div class="card p-3 text-center">
    <h2 class="text-warning">üèÜ Victory!</h2>
    <p id="victory-time">Time: 00:00.000</p>
    <button id="victory-replay-btn" class="btn btn-primary my-1">Replay Run</button>
    <button id="victory-menu-btn" class="btn btn-secondary my-1">Main Menu</button>
  </div>
</div>

<script>
const usernameScreen = document.getElementById('username-screen');
const connectScreen = document.getElementById('connect-screen');
const mazeScreen = document.getElementById('maze-screen');
const victoryModal = document.getElementById('victory-modal');
const victoryTime = document.getElementById('victory-time');
const victoryReplayBtn = document.getElementById('victory-replay-btn');
const victoryMenuBtn = document.getElementById('victory-menu-btn');

const usernameInput = document.getElementById('username-input');
const continueBtn = document.getElementById('continue-btn');
const singleBtn = document.getElementById('single-btn');
const openJoinBtn = document.getElementById('open-join-btn');
const joinCard = document.getElementById('join-card');
const serverIpInput = document.getElementById('server-ip-input');
const serverPortInput = document.getElementById('server-port-input');
const checkServerBtn = document.getElementById('check-server-btn');
const connectServerBtn = document.getElementById('connect-server-btn');
const userStats = document.getElementById('user-stats');

const mazeGrid = document.getElementById('maze-grid');
const keystrokesDiv = document.getElementById('keystrokes');
const stopwatchDisplay = document.getElementById('stopwatch');
const backBtn = document.getElementById('back-btn');

const size=21; const cellPx=25;
let maze=[], player={x:1,y:1}, endCell={x:size-2,y:size-2}, moves=[], startTime=null, timerInterval=null, gameWon=false;
let keys={w:false,a:false,s:false,d:false,ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
let username=localStorage.getItem('maze_username')||'', token=localStorage.getItem('maze_token')||'', stats={xp:0,runs:0,runsData:[]};

function formatTime(ms){if(!ms)return "00:00.000"; const s=Math.floor(ms/1000); const m=Math.floor(s/60); const sec=s%60; const msr=ms%1000; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(msr).padStart(3,'0')}`;}

function updateStatsDisplay(){userStats.textContent=`XP: ${stats.xp} | Runs: ${stats.runs}`;}

async function fetchNewToken(){try{const res=await fetch('https://supermaze-auth.onrender.com/api/new-token'); const data=await res.json(); token=data.token; stats=data.stats; localStorage.setItem('maze_token',token); updateStatsDisplay();}catch(e){alert('Failed to get token from server'); console.error(e);}}

async function updateStats(newXP, runData){try{if(!token){await fetchNewToken();} const res=await fetch(`https://supermaze-auth.onrender.com/api/stats/${token}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({xp:newXP,completed:stats.runs+1,run:runData})}); const d=await res.json(); stats=d.stats; updateStatsDisplay();}catch(e){console.error(e);}}

function initWallGrid(){maze=new Array(size); for(let y=0;y<size;y++){maze[y]=new Array(size).fill(1);}}
function carveMaze(){initWallGrid(); const stack=[]; const start={x:1,y:1}; maze[start.y][start.x]=0; stack.push(start); const dirs=[{dx:0,dy:-2},{dx:2,dy:0},{dx:0,dy:2},{dx:-2,dy:0}]; while(stack.length){const cur=stack[stack.length-1]; const neighbors=[]; for(const d of dirs){const nx=cur.x+d.dx; const ny=cur.y+d.dy;if(ny>0 && ny<size-1 && nx>0 && nx<size-1 && maze[ny][nx]===1) neighbors.push({x:nx,y:ny,via:d});} if(neighbors.length===0){stack.pop();}else{const n=neighbors[Math.floor(Math.random()*neighbors.length)]; const bx=cur.x+n.via.dx/2; const by=cur.y+n.via.dy/2; maze[by][bx]=0; maze[n.y][n.x]=0; stack.push({x:n.x,y:n.y});}}}
function placePlayerAndEnd(){function randomEmpty(){let attempts=0;while(attempts++<10000){const x=1+Math.floor(Math.random()*(size-2));const y=1+Math.floor(Math.random()*(size-2));if(maze[y][x]===0)return{x,y};}return{x:1,y:1;}} player=randomEmpty(); endCell=randomEmpty(); let tries=0; while((Math.abs(player.x-endCell.x)+Math.abs(player.y-endCell.y))<Math.floor(size/2)&&tries++<2000) endCell=randomEmpty();}
function generateMaze(){carveMaze(); placePlayerAndEnd();}
function renderMaze(ghostPos=null){mazeGrid.innerHTML=''; mazeGrid.style.gridTemplateColumns=`repeat(${size}, ${cellPx}px)`; mazeGrid.style.gridTemplateRows=`repeat(${size}, ${cellPx}px)`; const frag=document.createDocumentFragment(); for(let y=0;y<size;y++){for(let x=0;x<size;x++){const d=document.createElement('div'); d.className='cell'; if(maze[y][x]===1)d.classList.add('wall'); if(x===player.x&&y===player.y&&!(ghostPos&&ghostPos.x===x&&ghostPos.y===y))d.classList.add('player'); if(x===endCell.x&&y===endCell.y)d.classList.add('end'); if(ghostPos&&ghostPos.x===x&&ghostPos.y===y)d.classList.add('ghost'); frag.appendChild(d);}} mazeGrid.appendChild(frag);}

function startStopwatch(){startTime=performance.now(); stopwatchDisplay.textContent=formatTime(0); timerInterval=setInterval(()=>{stopwatchDisplay.textContent=formatTime(Math.round(performance.now()-startTime));},30);}
function stopStopwatch(){clearInterval(timerInterval); timerInterval=null;}
function resetStopwatch(){stopStopwatch(); startTime=null; stopwatchDisplay.textContent="00:00.000";}

function updateKeystrokes(){const layout=['W','A','S','D']; keystrokesDiv.innerHTML=''; layout.forEach(k=>{const span=document.createElement('span'); span.textContent=k; const lower=k.toLowerCase(); if(keys[lower]||keys[arrowMap[k]]) span.style.background='limegreen'; keystrokesDiv.appendChild(span);});}
const arrowMap={W:'ArrowUp',A:'ArrowLeft',S:'ArrowDown',D:'ArrowRight'};
document.addEventListener('keydown',(e)=>{if(gameWon)return; if(['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){e.preventDefault(); keys[e.key]=true; updateKeystrokes(); if(!startTime) startStopwatch(); let nx=player.x,ny=player.y; if(e.key==='w'||e.key==='ArrowUp') ny--; if(e.key==='s'||e.key==='ArrowDown') ny++; if(e.key==='a'||e.key==='ArrowLeft') nx--; if(e.key==='d'||e.key==='ArrowRight') nx++; if(maze[ny]&&maze[ny][nx]===0){player.x=nx; player.y=ny; moves.push({x:nx,y:ny,t:Math.round(performance.now()-startTime)}); renderMaze(); checkVictory();}}});
document.addEventListener('keyup',(e)=>{if(['w','a','s','d','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){keys[e.key]=false; updateKeystrokes();}});

function checkVictory(){if(player.x===endCell.x&&player.y===endCell.y&&!gameWon){gameWon=true; stopStopwatch(); const totalTime=Math.round(performance.now()-startTime); victoryTime.textContent=`Time: ${formatTime(totalTime)}`; victoryModal.classList.remove('d-none'); const runData={time:totalTime,moves:clone2D(moves)}; updateStats(stats.xp+Math.floor(totalTime/100), runData);}}
function clone2D(arr){return arr.map(r=>r.slice());}

victoryMenuBtn.onclick=()=>{victoryModal.classList.add('d-none'); mazeScreen.classList.add('d-none'); connectScreen.classList.remove('d-none'); moves=[]; resetStopwatch(); gameWon=false;}
victoryReplayBtn.onclick=()=>{alert('Replay not implemented in this version.');}

singleBtn.onclick=()=>{generateMaze(); renderMaze(); mazeScreen.classList.remove('d-none'); connectScreen.classList.add('d-none'); moves=[]; gameWon=false; resetStopwatch();}
backBtn.onclick=()=>{mazeScreen.classList.add('d-none'); connectScreen.classList.remove('d-none'); moves=[]; resetStopwatch(); gameWon=false;}

continueBtn.onclick=async()=>{
  username=usernameInput.value.trim(); if(!username)return alert('Enter username'); localStorage.setItem('maze_username',username);
  await fetchNewToken();
  usernameScreen.classList.add('d-none'); connectScreen.classList.remove('d-none');
  updateStatsDisplay();
};

openJoinBtn.onclick=()=>{joinCard.classList.toggle('d-none'); if(!serverPortInput.value) serverPortInput.value='3000';};

checkServerBtn.onclick=async()=>{const host=serverIpInput.value, port=serverPortInput.value||'3000'; try{const res=await fetch(`http://${host}:${port}`,{mode:'no-cors'}); alert('Server reachable');}catch(e){alert('Server not reachable');}};

connectServerBtn.onclick=()=>{const host=serverIpInput.value, port=serverPortInput.value||'3000'; if(!host)return alert('Enter host'); const ok=confirm(`Redirect to http://${host}:${port}?`); if(ok) window.location.href=`http://${host}:${port}`;};

if(username){usernameInput.value=username; continueBtn.click();}
</script>
</body>
</html>
